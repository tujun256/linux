name: build dtb

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ master ]
    paths:
      - 'arch/arm64/boot/dts/rockchip/rk3588-HL-ZF9000.dts'  # åŒ¹é…DTSæ–‡ä»¶

jobs:
  build-specific-dtb:
    runs-on: ubuntu-latest
    steps:
      ########################################################################
      # æ­¥éª¤1ï¼šæ£€å‡º tujun256/linux ä»“åº“
      ########################################################################
      - name: æ£€å‡º tujun256/linux ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: tujun256/linux
          path: linux
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      ########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–
      ########################################################################
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcc-aarch64-linux-gnu  # arm64äº¤å‰å·¥å…·é“¾
          sudo apt-get install -y device-tree-compiler make bc flex bison libssl-dev

      ########################################################################
      # æ­¥éª¤3ï¼šä¿®å¤æ·»åŠ DTBç¼–è¯‘è§„åˆ™çš„æ–¹æ³•ï¼ˆå·²ä¿®æ­£ï¼‰
      ########################################################################
      - name: éªŒè¯/æ·»åŠ  rk3588-HL-ZF9000.dtb ç¼–è¯‘è§„åˆ™
        run: |
          DTS_FILE="rk3588-HL-ZF9000.dts"
          DTB_FILE="${DTS_FILE%.dts}.dtb"
          MAKEFILE_PATH="./linux/arch/arm64/boot/dts/rockchip/Makefile"
          INSERT_LINE="dtb-\$(CONFIG_ARCH_ROCKCHIP) += $DTB_FILE"

          # å¢åŠ è°ƒè¯•ä¿¡æ¯ï¼Œæ˜¾ç¤ºMakefileä¸­å·²æœ‰çš„ç›¸å…³è§„åˆ™
          echo "ğŸ“‹ å½“å‰Makefileä¸­çš„Rockchip DTBè§„åˆ™ï¼š"
          grep "dtb-\$(CONFIG_ARCH_ROCKCHIP) += " "$MAKEFILE_PATH" || true

          # æ£€æŸ¥è§„åˆ™æ˜¯å¦å·²å­˜åœ¨
          if ! grep -q "^${INSERT_LINE}$" "$MAKEFILE_PATH"; then
            echo "â„¹ï¸ æ­£åœ¨æ·»åŠ  $DTB_FILE è§„åˆ™..."
            
            # æ”¹è¿›ï¼šå…ˆå°è¯•åœ¨ç±»ä¼¼è¡Œå‰æ’å…¥ï¼Œå¦‚å¤±è´¥åˆ™åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ 
            if ! sed -i "/^dtb-\$(CONFIG_ARCH_ROCKCHIP) += /i ${INSERT_LINE}" "$MAKEFILE_PATH"; then
              echo "âš ï¸ æ— æ³•åœ¨ç°æœ‰è§„åˆ™å‰æ’å…¥ï¼Œå°è¯•æ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾"
              echo "${INSERT_LINE}" >> "$MAKEFILE_PATH"
            fi
            
            # äºŒæ¬¡éªŒè¯
            if grep -q "^${INSERT_LINE}$" "$MAKEFILE_PATH"; then
              echo "âœ… è§„åˆ™æ·»åŠ æˆåŠŸï¼š${INSERT_LINE}"
            else
              echo "âŒ è§„åˆ™æ·»åŠ å¤±è´¥"
              exit 1
            fi
          else
            echo "â„¹ï¸ è§„åˆ™å·²å­˜åœ¨ï¼Œæ— éœ€æ·»åŠ "
          fi

      ########################################################################
      # æ­¥éª¤4ï¼šé…ç½®å†…æ ¸
      ########################################################################
      - name: é…ç½®å†…æ ¸
        run: |
          cd ./linux
          make ARCH=arm64 defconfig -j$(nproc)
          # ç¡®ä¿Rockchipæ¶æ„å¯ç”¨
          if ! grep -q "CONFIG_ARCH_ROCKCHIP=y" .config; then
            echo "CONFIG_ARCH_ROCKCHIP=y" >> .config
            echo "âœ… æ‰‹åŠ¨å¯ç”¨Rockchipæ¶æ„"
          else
            echo "âœ… Rockchipæ¶æ„å·²å¯ç”¨"
          fi

      ########################################################################
      # æ­¥éª¤5ï¼šç¼–è¯‘DTB
      ########################################################################
      - name: ç¼–è¯‘ rk3588-HL-ZF9000.dtb
        run: |
          cd ./linux
          DTB_FILE="rk3588-HL-ZF9000.dtb"
          DTB_PATH="arch/arm64/boot/dts/rockchip/$DTB_FILE"

          # ç¼–è¯‘DTB
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- dtbs -j$(nproc)

          # éªŒè¯ç¼–è¯‘ç»“æœ
          if [ -f "$DTB_PATH" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼æ–‡ä»¶è·¯å¾„ï¼š$DTB_PATH"
            ls -lh "$DTB_PATH"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ° $DTB_PATH"
            exit 1
          fi

      ########################################################################
      # æ­¥éª¤6ï¼šä¸Šä¼ äº§ç‰©
      ########################################################################
      - name: ä¸Šä¼  DTB äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: rk3588-HL-ZF9000-dtb
          path: ./linux/arch/arm64/boot/dts/rockchip/rk3588-HL-ZF9000.dtb
          retention-days: 90
          if-no-files-found: error
